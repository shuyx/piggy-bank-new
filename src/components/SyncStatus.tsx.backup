import React, { useState, useEffect } from 'react'
import { supabaseService } from '../lib/supabaseService'
import { useStore } from '../stores/useStore'

export const SyncStatus: React.FC = () => {
  const [user, setUser] = useState<any>(null)
  const [syncing, setSyncing] = useState(false)
  const [lastSync, setLastSync] = useState<string>('')
  const store = useStore()

  useEffect(() => {
    checkUser()
  }, [])

  const checkUser = async () => {
    const currentUser = await supabaseService.getCurrentUser()
    setUser(currentUser)
  }

  const handleSync = async () => {
    if (!user) return
    
    setSyncing(true)
    try {
      const result = await supabaseService.syncUserData({
        totalStars: store.totalStars,
        currentStreak: store.currentStreak,
        dailyRecords: store.dailyRecords,
        achievements: store.achievements,
        customTasks: store.customTasks
      })

      if (result.success) {
        setLastSync(new Date().toLocaleString('zh-CN'))
        alert('æ•°æ®åŒæ­¥æˆåŠŸï¼')
      } else {
        alert('åŒæ­¥å¤±è´¥ï¼š' + result.error)
      }
    } catch (error) {
      alert('åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setSyncing(false)
    }
  }

  const handleLoadFromCloud = async () => {
    if (!user) return

    try {
      const result = await supabaseService.getUserData()
      if (result.success && result.data) {
        // è¿™é‡Œéœ€è¦è°ƒç”¨ store çš„æ–¹æ³•æ¥æ›´æ–°æœ¬åœ°æ•°æ®
        // ä½ éœ€è¦åœ¨ useStore ä¸­æ·»åŠ ä¸€ä¸ª loadFromCloud æ–¹æ³•
        alert('æ•°æ®åŠ è½½æˆåŠŸï¼')
        window.location.reload() // ä¸´æ—¶æ–¹æ¡ˆï¼Œåˆ·æ–°é¡µé¢
      } else {
        alert('äº‘ç«¯æš‚æ— æ•°æ®')
      }
    } catch (error) {
      alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  const handleSignOut = async () => {
    await supabaseService.signOut()
    setUser(null)
    alert('å·²é€€å‡ºç™»å½•')
  }

  if (!user) return null

  return (
    <div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="text-2xl">â˜ï¸</div>
          <div>
            <div className="font-bold text-piggy-blue">äº‘ç«¯åŒæ­¥</div>
            <div className="text-sm text-gray-600">
              {user.email} | {lastSync ? `ä¸Šæ¬¡åŒæ­¥: ${lastSync}` : 'æœªåŒæ­¥'}
            </div>
          </div>
        </div>
        
        <div className="flex gap-2">
          <button
            onClick={handleSync}
            disabled={syncing}
            className="bg-piggy-green text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 disabled:opacity-50"
          >
            {syncing ? 'åŒæ­¥ä¸­...' : 'ğŸ“¤ åŒæ­¥'}
          </button>
          
          <button
            onClick={handleLoadFromCloud}
            className="bg-piggy-blue text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600"
          >
            ğŸ“¥ åŠ è½½
          </button>
          
          <button
            onClick={handleSignOut}
            className="bg-gray-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-600"
          >
            é€€å‡º
          </button>
        </div>
      </div>
    </div>
  )
}